<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASS | Teacher Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #b8860b; --navy: #003366; }
        body { font-family: sans-serif; background: #001a33; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        /* Login UI */
        #login-page { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; border-top: 8px solid var(--gold); }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-green { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        
        /* Dashboard UI */
        #dashboard { display: none; background: #f4f4f4; width: 100%; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .header { background: var(--navy); color: white; padding: 20px; border-radius: 15px; text-align: center; border-bottom: 5px solid var(--gold); margin-bottom: 20px; }
        .student-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 6px solid var(--gold); }
        
        /* Grading Table */
        #grading-ui { display: none; background: white; padding: 15px; border-radius: 15px; width: 100%; max-width: 800px; margin: auto; }
        .scroll-table { overflow-x: auto; margin: 15px 0; }
        table { width: 100%; min-width: 600px; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
        th { background: var(--navy); color: white; }
        .avg-cell { background: #fdf5e6; font-weight: bold; }
        .save-bar { position: sticky; bottom: 0; background: var(--gold); color: white; width: 100%; padding: 18px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div id="login-page">
    <div style="font-size: 24px; font-weight: bold; color: var(--navy); margin-bottom: 5px;">RASS</div>
    <div style="color: var(--gold); font-weight: bold; margin-bottom: 20px;">Teacher Login</div>
    <input type="text" id="tid" placeholder="Enter Teacher ID (e.g. Blessed001)">
    <button class="btn-green" onclick="doLogin()">LOGIN</button>
</div>

<div id="dashboard">
    <div class="header">
        <h2 style="margin:0;">ROYAL ACADEMY</h2>
        <small>Official Teacher Portal</small>
    </div>
    
    <div id="main-list">
        <button class="btn-green" style="margin-bottom:20px;" onclick="showGrading()">+ ADD NEW STUDENT</button>
        <div id="list-container">Loading students...</div>
    </div>

    <div id="grading-ui">
        <button onclick="hideGrading()" style="border:none; background:none; color:var(--navy); font-weight:bold; cursor:pointer;">‚Üê BACK TO LIST</button>
        <h3 id="edit-title" style="color:var(--navy);">New Student Entry</h3>
        
        <input type="text" id="s_name" placeholder="Full Student Name">
        <select id="s_class">
            <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
            <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
        </select>

        <div class="scroll-table">
            <table>
                <thead>
                    <tr>
                        <th style="text-align:left;">Subject</th>
                        <th>1st Pd</th><th>2nd Pd</th><th>3rd Pd</th><th>Exam</th>
                        <th class="avg-cell">Ave.</th>
                    </tr>
                </thead>
                <tbody id="grade-rows"></tbody>
            </table>
        </div>

        <textarea id="s_remarks" placeholder="Teacher's Remarks..." style="width:100%; height:60px; padding:10px; border-radius:10px; border:1px solid #ddd;"></textarea>
        <button class="save-bar" onclick="submitGrades()">SAVE ALL DATA</button>
    </div>
</div>

<script>
    const _sb = supabase.createClient('https://thhrfrxvaxezcoutpzby.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaHJmcnh2YXhlemNvdXRwemJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjY2NTAsImV4cCI6MjA4MzM0MjY1MH0.9oYLT4E5_lvDn8TSO2L1T2JPG3YLQPuh2tzAYYZW6qI');
    
    const validIDs = ["Blessed001", "Cooper002", "James003", "K1004", "Abc005", "Marcus007", "Ben008"];
    const rassSubs = ["Bible", "English", "Reading", "General Science", "Mathematics", "Social Studies", "Spelling", "Phonics", "Health Science", "Writing", "Listening Skill", "Drawing", "P.E"];
    let editModeId = null;

    function doLogin() {
        const id = document.getElementById('tid').value.trim();
        if(validIDs.includes(id)) {
            localStorage.setItem('tID', id);
            document.body.style.background = "#f4f4f4";
            document.getElementById('login-page').style.display = "none";
            document.getElementById('dashboard').style.display = "block";
            loadStudents();
        } else { alert("Access Denied"); }
    }

    function showGrading() {
        editModeId = null;
        document.getElementById('main-list').style.display = "none";
        document.getElementById('grading-ui').style.display = "block";
        document.getElementById('s_name').value = "";
        renderRows();
    }

    function hideGrading() {
        document.getElementById('main-list').style.display = "block";
        document.getElementById('grading-ui').style.display = "none";
        loadStudents();
    }

    function renderRows() {
        let h = "";
        rassSubs.forEach(s => {
            let id = s.toLowerCase().replace(/\s/g, '');
            h += `<tr>
                <td style="text-align:left; font-weight:bold;">${s}</td>
                <td><input type="number" id="${id}_p1" oninput="calcAvg('${id}')" style="width:40px;"></td>
                <td><input type="number" id="${id}_p2" oninput="calcAvg('${id}')" style="width:40px;"></td>
                <td><input type="number" id="${id}_p3" oninput="calcAvg('${id}')" style="width:40px;"></td>
                <td><input type="number" id="${id}_ex" oninput="calcAvg('${id}')" style="width:40px;"></td>
                <td id="${id}_ave" class="avg-cell"></td>
            </tr>`;
        });
        document.getElementById('grade-rows').innerHTML = h;
    }

    function calcAvg(id) {
        let vals = [
            parseFloat(document.getElementById(id+'_p1').value) || 0,
            parseFloat(document.getElementById(id+'_p2').value) || 0,
            parseFloat(document.getElementById(id+'_p3').value) || 0,
            parseFloat(document.getElementById(id+'_ex').value) || 0
        ];
        let filtered = vals.filter(v => v > 0);
        document.getElementById(id+'_ave').innerText = filtered.length > 0 ? (filtered.reduce((a,b)=>a+b)/filtered.length).toFixed(0) : "";
    }

    async function loadStudents() {
        const { data } = await _sb.from('grades').select('*').eq('teacher_id', localStorage.getItem('tID'));
        const container = document.getElementById('list-container');
        container.innerHTML = data.length ? "" : "No records yet.";
        data.forEach(s => {
            container.innerHTML += `<div class="student-card">
                <div><strong>${s.student_name}</strong><br><small>${s.student_class}</small></div>
                <button onclick='startEdit(${JSON.stringify(s)})' style="background:var(--navy); color:white; border:none; padding:8px 15px; border-radius:5px;">Edit</button>
            </div>`;
        });
    }

    function startEdit(s) {
        showGrading();
        editModeId = s.id;
        document.getElementById('s_name').value = s.student_name;
        document.getElementById('s_class').value = s.student_class;
        document.getElementById('s_remarks').value = s.teacher_remarks || "";
        rassSubs.forEach(sub => {
            let id = sub.toLowerCase().replace(/\s/g, '');
            if(s.scores[id]) {
                document.getElementById(id+'_p1').value = s.scores[id].p1 || "";
                document.getElementById(id+'_p2').value = s.scores[id].p2 || "";
                document.getElementById(id+'_p3').value = s.scores[id].p3 || "";
                document.getElementById(id+'_ex').value = s.scores[id].ex || "";
                calcAvg(id);
            }
        });
    }

    async function submitGrades() {
        const name = document.getElementById('s_name').value;
        if(!name) return alert("Student name required");
        let scores = {};
        rassSubs.forEach(s => {
            let id = s.toLowerCase().replace(/\s/g, '');
            scores[id] = {
                p1: document.getElementById(id+'_p1').value,
                p2: document.getElementById(id+'_p2').value,
                p3: document.getElementById(id+'_p3').value,
                ex: document.getElementById(id+'_ex').value
            };
        });
        const payload = { student_name: name, student_class: document.getElementById('s_class').value, scores: scores, teacher_remarks: document.getElementById('s_remarks').value, teacher_id: localStorage.getItem('tID'), academic_year: "2025-2026" };
        const { error } = editModeId ? await _sb.from('grades').update(payload).eq('id', editModeId) : await _sb.from('grades').insert([payload]);
        if(error) alert(error.message); else { alert("Success!"); hideGrading(); }
    }
</script>
</body>
    </html>
