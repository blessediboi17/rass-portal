<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Card | Royal Academy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Times New Roman', serif; background: #f0f0f0; margin: 0; padding: 10px; }
        .no-print { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .report-box { background: white; padding: 30px; border: 1px solid #000; max-width: 800px; margin: auto; position: relative; }
        .school-header { text-align: center; margin-bottom: 20px; }
        .school-name { font-size: 24px; font-weight: bold; margin: 0; color: #000; text-transform: uppercase; }
        .school-info { font-size: 14px; margin: 5px 0; }
        .student-info-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 13px; }
        th { background: #f2f2f2; }
        .subject-name { text-align: left; padding-left: 10px; font-weight: bold; }
        .avg-row { font-weight: bold; background: #f9f9f9; }
        .evaluation-table { margin-top: 20px; width: 60%; }
        .red-score { color: red; font-weight: bold; }
        @media print { .no-print { display: none; } body { background: white; padding: 0; } .report-box { border: none; } }
    </style>
</head>
<body>

<div class="no-print">
    <input type="text" id="search" placeholder="Enter Student Name" style="padding:12px; width:60%; border:1px solid #ccc; border-radius:8px;">
    <button onclick="fetchResult()" style="padding:12px 20px; background:#003366; color:white; border:none; border-radius:8px; font-weight:bold;">VIEW RESULT</button>
</div>

<div id="result" class="report-box" style="display:none;">
    <div class="school-header">
        <h1 class="school-name">ROYAL ACADEMY SCHOOL SYSTEM</h1>
        <div class="school-info">Nursery, Kindergarten & Elementary</div>
        <div class="school-info">New Life Community, Lower Johnsonville</div>
        <div class="school-info">Montserrado County, Liberia</div>
    </div>
    
    <div class="student-info-bar">
        <span>Name: <span id="rName" style="text-decoration: underline;"></span></span>
        <span>Class: <span id="rClass" style="text-decoration: underline;"></span></span>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 30px;">No.</th>
                <th style="text-align:left;">Subject</th>
                <th>1st Pd</th>
                <th>2nd Pd</th>
                <th>3rd Pd</th>
                <th>Exam</th>
                <th>Ave.</th>
            </tr>
        </thead>
        <tbody id="rTable">
            </tbody>
        <tfoot>
            <tr class="avg-row">
                <td>14</td>
                <td style="text-align:left;">Average</td>
                <td id="avg_p1"></td>
                <td id="avg_p2"></td>
                <td id="avg_p3"></td>
                <td id="avg_ex1"></td>
                <td id="avg_sem1"></td>
            </tr>
        </tfoot>
    </table>

    <div class="evaluation-table">
        <table>
            <tr><th colspan="2">Evaluation</th></tr>
            <tr><td style="text-align:left;">Effort</td><td></td></tr>
            <tr><td style="text-align:left;">Preparedness</td><td></td></tr>
            <tr><td style="text-align:left;">Conduct/Moral</td><td></td></tr>
        </table>
        <p style="font-size: 11px; margin-top: 5px;">S=Satisfactory, U=Unsatisfactory</p>
    </div>

    <button class="no-print" onclick="window.print()" style="width:100%; padding:15px; margin-top:20px; background:#28a745; color:white; border:none; font-weight:bold; border-radius:10px;">PRINT REPORT CARD</button>
</div>

<script>
    const _sb = supabase.createClient('https://thhrfrxvaxezcoutpzby.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaHJmcnh2YXhlemNvdXRwemJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjY2NTAsImV4cCI6MjA4MzM0MjY1MH0.9oYLT4E5_lvDn8TSO2L1T2JPG3YLQPuh2tzAYYZW6qI');

    async function fetchResult() {
        const nameInput = document.getElementById('search').value.trim();
        const { data, error } = await _sb.from('grades').select('*').ilike('student_name', `%${nameInput}%`).limit(1);

        if(data && data.length > 0) {
            const res = data[0];
            document.getElementById('rName').innerText = res.student_name;
            document.getElementById('rClass').innerText = res.student_class;

            let h = "";
            let pTotals = {p1:0,p2:0,p3:0,ex1:0}, pCounts = {p1:0,p2:0,p3:0,ex1:0};
            let subjects = Object.keys(res.scores);

            subjects.forEach((sub, index) => {
                let row = `<tr><td>${index + 1}</td><td class="subject-name">${sub.toUpperCase()}</td>`;
                let s1sum = 0, s1c = 0;

                ["p1","p2","p3","ex1"].forEach(p => {
                    let v = parseFloat(res.scores[sub][p]);
                    // Only show if the grade is greater than 0
                    let displayVal = (v > 0) ? v : ""; 
                    
                    if(v > 0) {
                        pTotals[p] += v; pCounts[p]++;
                        s1sum += v; s1c++;
                    }
                    
                    let colorClass = (v > 0 && v < 75) ? 'red-score' : '';
                    row += `<td class="${colorClass}">${displayVal}</td>`;
                });

                // Subject Average (Row Average)
                let rowAvg = s1c > 0 ? (s1sum/s1c).toFixed(1) : "";
                row += `<td style="font-weight:bold;">${rowAvg}</td></tr>`;
                h += row;
            });

            document.getElementById('rTable').innerHTML = h;

            // Vertical Period Averages (The bottom row)
            ["p1","p2","p3","ex1"].forEach(p => {
                let pAvg = pCounts[p] > 0 ? (pTotals[p]/pCounts[p]).toFixed(1) : "";
                document.getElementById(`avg_${p}`).innerText = pAvg;
            });

            document.getElementById('result').style.display = "block";
        } else {
            alert("No student found.");
        }
    }
</script>
</body>
        </html>
