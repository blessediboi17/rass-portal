<!DOCTYPE html>
<html>
<head>
    <title>RASS | View Report Card</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Times New Roman', serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 40px; border: 1px solid #ccc; }
        
        /* Letterhead Styling */
        .letterhead { text-align: center; border-bottom: 3px double #003366; margin-bottom: 20px; }
        .logo { width: 100px; }
        .school-name { color: #003366; font-size: 28px; font-weight: bold; margin: 5px 0; }
        
        /* Search Box (Hidden during Print) */
        .no-print { text-align: center; background: #eef2f7; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ccc; }
        input { padding: 12px; width: 300px; border: 1px solid #999; border-radius: 4px; }
        .btn { background: #003366; color: white; padding: 12px 25px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
        th { background: #f2f2f2; }
        .failing { color: red !important; font-weight: bold; }
        
        /* Footer */
        .footer-area { display: flex; justify-content: space-between; margin-top: 60px; }
        .sig-box { border-top: 2px solid #000; width: 200px; text-align: center; padding-top: 5px; }
        .stamp-circle { border: 2px dashed #ccc; width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 10px; text-align: center; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .container { border: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <h3>Royal Academy Result Portal</h3>
    <input type="text" id="studentSearch" placeholder="Enter Student's Full Name">
    <button class="btn" onclick="searchGrades()">View Result</button>
</div>

<div id="reportCard" class="container" style="display:none;">
    <div class="letterhead">
        <img src="IMG_20260107_084912.jpg" class="logo">
        <div class="school-name">ROYAL ACADEMY SCHOOL SYSTEM</div>
        <div style="font-size: 14px;">
            Nursery, Kindergarten & Elementary<br>
            New Life Community, Lower Johnsonville, Liberia<br>
            <i>"Quality Education for a Brighter Future"</i>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px;">
        <span>NAME: <span id="dispName" style="color:#003366"></span></span>
        <span>CLASS: <span id="dispClass" style="color:#003366"></span></span>
        <span>YEAR: <span id="dispYear" style="color:#003366"></span></span>
    </div>

    <table>
        <thead>
            <tr>
                <th>Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Ex 1</th>
                <th>4th</th><th>5th</th><th>6th</th><th>Final</th><th>AVG</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>

    <div style="margin-top: 20px; border: 1px solid #000; padding: 10px;">
        <strong>TEACHER'S REMARKS:</strong>
        <p id="dispRemarks" style="font-style: italic; margin: 5px 0;"></p>
    </div>

    <div class="footer-area">
        <div class="stamp-circle">OFFICIAL<br>SCHOOL STAMP</div>
        <div class="sig-box">Principal's Signature</div>
    </div>

    <button class="btn no-print" onclick="window.print()" style="width: 100%; margin-top: 20px; background: #28a745;">PRINT / SAVE AS PDF</button>
</div>

<script>
    // Supabase Setup
    const _sb = supabase.createClient('https://thhrfrxvaxezcoutpzby.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaHJmcnh2YXhlemNvdXRwemJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjY2NTAsImV4cCI6MjA4MzM0MjY1MH0.9oYLT4E5_lvDn8TSO2L1T2JPG3YLQPuh2tzAYYZW6qI');

    async function searchGrades() {
        const name = document.getElementById('studentSearch').value;
        const { data, error } = await _sb
            .from('grades')
            .select('*')
            .ilike('student_name', name)
            .limit(1);

        if (data && data.length > 0) {
            const student = data[0];
            document.getElementById('dispName').innerText = student.student_name.toUpperCase();
            document.getElementById('dispClass').innerText = student.student_class;
            document.getElementById('dispYear').innerText = student.academic_year;
            document.getElementById('dispRemarks').innerText = student.teacher_remarks || "No comments.";
            
            let tableHTML = "";
            for (let sub in student.scores) {
                let subSum = 0;
                let row = `<tr><td style="text-align:left; font-weight:bold;">${sub.toUpperCase()}</td>`;
                const periods = ["p1", "p2", "p3", "ex1", "p4", "p5", "p6", "ex2"];
                
                periods.forEach(p => {
                    let score = parseFloat(student.scores[sub][p]) || 0;
                    subSum += score;
                    row += `<td class="${(score < 75 && score > 0) ? 'failing' : ''}">${score || '-'}</td>`;
                });
                
                row += `<td style="background:#f9f9f9; font-weight:bold;">${(subSum / 8).toFixed(1)}</td></tr>`;
                tableHTML += row;
            }
            document.getElementById('resultBody').innerHTML = tableHTML;
            document.getElementById('reportCard').style.display = "block";
        } else {
            alert("Record not found for: " + name);
        }
    }
</script>
</body>
        </html>
