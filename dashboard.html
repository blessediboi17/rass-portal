<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RASS | Teacher Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #003366; padding-bottom: 10px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #003366; color: white; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 13px; }
        .btn-add { background: #28a745; color: white; padding: 12px 20px; }
        .btn-view { background: #003366; color: white; margin-right: 5px; }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #003366; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="login-overlay" class="login-overlay">
    <div class="login-box">
        <h2>Teacher Access</h2>
        <p>Enter your unique Teacher ID (e.g., TEACHER1)</p>
        <input type="text" id="teacher-id-input" style="padding:10px; width:200px; border:1px solid #ccc; border-radius:5px;"><br><br>
        <button class="btn btn-add" onclick="login()">Enter Dashboard</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0; color:#003366;">Teacher Dashboard</h1>
            <p id="teacher-display" style="margin:5px 0; font-weight:bold;"></p>
        </div>
        <a href="grading.html" id="add-link" class="btn btn-add">+ Add New Student</a>
    </div>

    <h3>My Assigned Students</h3>
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Class</th>
                <th>Academic Year</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="student-list">
            </tbody>
    </table>
</div>

<script>
    const _sb = supabase.createClient('https://thhrfrxvaxezcoutpzby.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaHJmcnh2YXhlemNvdXRwemJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjY2NTAsImV4cCI6MjA4MzM0MjY1MH0.9oYLT4E5_lvDn8TSO2L1T2JPG3YLQPuh2tzAYYZW6qI');

    let currentTeacher = "";

    function login() {
        const id = document.getElementById('teacher-id-input').value.trim();
        if(!id) return alert("Enter ID");
        currentTeacher = id;
        document.getElementById('login-overlay').style.display = "none";
        document.getElementById('teacher-display').innerText = "Logged in: " + currentTeacher;
        
        // Update the "Add New" link to remember who is adding the student
        document.getElementById('add-link').href = `grading.html?tid=${currentTeacher}`;
        
        loadStudents();
    }

    async function loadStudents() {
        const { data, error } = await _sb
            .from('grades')
            .select('*')
            .eq('teacher_id', currentTeacher); // THIS IS THE SECURITY FILTER

        const list = document.getElementById('student-list');
        list.innerHTML = "";

        if (data && data.length > 0) {
            data.forEach(s => {
                list.innerHTML += `
                    <tr>
                        <td>${s.student_name}</td>
                        <td>${s.student_class}</td>
                        <td>${s.academic_year}</td>
                        <td>
                            <a href="check-result.html?name=${encodeURIComponent(s.student_name)}" class="btn btn-view">View Report</a>
                        </td>
                    </tr>
                `;
            });
        } else {
            list.innerHTML = "<tr><td colspan='4'>No students found assigned to your ID.</td></tr>";
        }
    }
</script>
</body>
</html>
